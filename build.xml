<?xml version="1.0" encoding="UTF-8"?>
<project basedir="." default="all" name="OmegaT">

    <target name="init">
        <property name="iscc.exe" value="m:/progs/Inno Setup 4/iscc.exe"/>

        <property name="jar" location="tmp/${ant.project.name}.jar"/>
        
        <property file="src/org/omegat/Version.properties"/>
    </target>

    <target name="compile" depends="init">
        <mkdir dir="classes"/>
        <copy todir="classes/org/omegat">
            <fileset dir="src/org/omegat" includes="*.properties"/>
        </copy>
        <javac debug="true" deprecation="true" destdir="classes" srcdir="src"/>
    </target>

    <target name="jar" depends="init,compile">
        <mkdir dir="tmp"/>
        <jar basedir="classes" compress="false" jarfile="${jar}">
            <manifest>
                <attribute name="Main-Class" value="org.omegat.Main"/>
                <attribute name="License" value="GNU Public License version 2"/>
                <attribute name="Specification-Version" value="${specification-version}"/>
                <attribute name="Implementation-Version" value="${version}"/>
            </manifest>
        </jar>
    </target>

    <target name="clean" depends="init" description="Clean all build products.">
        <delete dir="classes"/>
        <delete dir="dist"/>
        <delete dir="tmp"/>
        <ant dir="addons/properties-import" target="clean" inheritAll="false"/>
    </target>

    <target name="win" description="Build Win32 distro" depends="init,jar,zip">
        <copy todir="tmp" file="release/win32-specific/OmegaT.exe"/>

	<filter token="VERSION_NUMBER_SUBST" value="${version}"/>
        <copy todir="tmp" file="release/win32-specific/OmegaT.iss" filtering="on"/>
        
        <mkdir dir="dist"/>
        <exec executable="${iscc.exe}">
            <arg file="tmp/OmegaT.iss"/>
        </exec>
    </target>

    <target name="zip" description="Build Zip distro" depends="init,jar">
        <mkdir dir="tmp"/>
        <copy todir="tmp">
            <fileset dir="release" includes="*" excludes="win32-specific"/>
        </copy>
        <mkdir dir="tmp/docs"/>
        <copy todir="tmp/docs">
            <fileset dir="docs"/>
        </copy>
        <mkdir dir="tmp/images"/>
        <copy todir="tmp/images">
            <fileset dir="images"/>
        </copy>
        
        <mkdir dir="dist"/>
        <zip basedir="tmp" destfile="dist/OmegaT_${version}.zip"/>

        <ant dir="addons/properties-import" inheritAll="false"/>
        <copy todir="dist" file="addons/properties-import/import_properties.zip"/>
    </target>

    <target name="src" depends="init" description="Build source distribution">
        <mkdir dir="dist"/>
        <zip destfile="dist/OmegaT_src_${version}.zip" basedir="." includes="addons/** docs/** images/** release/** src/** build.xml"/>
    </target>


    <target name="all" depends="src,zip,win" description="Build distributions."/>
    
    <target name="run" depends="compile">
        <java classpath="classes" classname="org.omegat.Main" fork="true"/>
    </target>
    
    <target name="debug" depends="compile" if="netbeans.home" description="Debug Project">
        <nbjpdastart name="OmegaT" addressproperty="jpda.address" transport="dt_socket">
            <classpath path="classes"/>
        </nbjpdastart>
        <java fork="true" classname="org.omegat.Main">
            <jvmarg value="-Xdebug"/>
            <jvmarg value="-Xnoagent"/>     
            <jvmarg value="-Djava.compiler=none"/>     
            <jvmarg value="-Xrunjdwp:transport=dt_socket,address=${jpda.address}"/>     
            <classpath path="classes"/>
        </java> 
    </target>
</project>
